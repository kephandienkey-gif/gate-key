<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Admin Panel</title>
<style>
body{
  background:#111;
  color:white;
  font-family:sans-serif;
  margin:0;
  padding:20px;
}
.box{
  max-width:500px;
  margin:auto;
  background:#1c1c1c;
  padding:20px;
  border-radius:12px;
}
input{
  width:100%;
  padding:10px;
  margin:5px 0;
  border:none;
  border-radius:6px;
}
button{
  padding:10px;
  margin:5px 0;
  width:100%;
  border:none;
  border-radius:6px;
  font-weight:bold;
  cursor:pointer;
}
.create{background:#00ffcc;}
.random{background:#ffcc00;}
.bulk{background:#00aaff;}
.logout{background:#ff4444;}
.keyItem{
  background:#222;
  padding:10px;
  margin:8px 0;
  border-radius:8px;
}
</style>
</head>
<body>

<div class="box" id="loginBox">
  <h2>ƒêƒÉng nh·∫≠p Admin</h2>
  <input type="email" id="email" placeholder="Email">
  <input type="password" id="password" placeholder="Password">
  <button onclick="login()">Login</button>
</div>

<div class="box" id="adminBox" style="display:none;">

  <h3>Th·ªëng k√™</h3>
  T·ªïng key: <span id="totalKeys">0</span><br>
  T·ªïng l∆∞·ª£t get: <span id="totalGet">0</span>

  <hr>

  <h3>T·∫°o key th·ªß c√¥ng</h3>
  <input type="text" id="newKey" placeholder="Nh·∫≠p key (ƒë·ªÉ tr·ªëng s·∫Ω random)">
  <input type="number" id="expireHours" placeholder="H·∫øt h·∫°n (gi·ªù)">
  <button class="create" onclick="createKey()">T·∫°o Key</button>

  <h3>T·∫°o key h√†ng lo·∫°t</h3>
  <input type="number" id="bulkCount" placeholder="S·ªë l∆∞·ª£ng key">
  <input type="number" id="bulkUses" placeholder="S·ªë l∆∞·ª£t m·ªói key">
  <input type="number" id="bulkExpire" placeholder="H·∫øt h·∫°n (gi·ªù)">
  <button class="bulk" onclick="createBulk()">T·∫°o h√†ng lo·∫°t</button>

  <h3>Danh s√°ch key</h3>
  <div id="keyList"></div>

  <button class="logout" onclick="logout()">ƒêƒÉng xu·∫•t</button>

</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyCBoDV8N9q56YjrNlKoiQk6c6fYDNJL2pw",
  authDomain: "kephandienkey-fbee7.firebaseapp.com",
  projectId: "kephandienkey-fbee7",
  storageBucket: "kephandienkey-fbee7.appspot.com",
  messagingSenderId: "1004820527441",
  appId: "1:1004820527441:web:a2ffa3aefb82b99a97fb70"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const loginBox = document.getElementById("loginBox");
const adminBox = document.getElementById("adminBox");
const keyList = document.getElementById("keyList");
const totalKeysEl = document.getElementById("totalKeys");
const totalGetEl = document.getElementById("totalGet");

function randomKey(){
  return "VIP-" + Math.random().toString(36).substring(2,10).toUpperCase();
}

window.login = async function(){
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  try{
    await signInWithEmailAndPassword(auth,email,password);
    alert("ƒêƒÉng nh·∫≠p th√†nh c√¥ng");
  }catch{
    alert("Sai t√†i kho·∫£n");
  }
}

onAuthStateChanged(auth,(user)=>{
  if(user){
    loginBox.style.display="none";
    adminBox.style.display="block";
    loadKeys();
  }else{
    loginBox.style.display="block";
    adminBox.style.display="none";
  }
});

window.createKey = async function(){
  let key = document.getElementById("newKey").value;
  const hours = parseInt(document.getElementById("expireHours").value);

  if(!hours){ alert("Nh·∫≠p gi·ªù h·∫øt h·∫°n"); return; }
  if(!key) key = randomKey();

  await addDoc(collection(db,"keys"),{
    key:key,
    maxUses:1,
    used:0,
    createdAt:Date.now(),
    expiresAt:Date.now() + hours*60*60*1000
  });

  alert("T·∫°o key th√†nh c√¥ng");
  loadKeys();
}

window.createBulk = async function(){

  const count = parseInt(document.getElementById("bulkCount").value);
  const uses = parseInt(document.getElementById("bulkUses").value);
  const hours = parseInt(document.getElementById("bulkExpire").value);

  if(!count || count<=0){ alert("Nh·∫≠p s·ªë l∆∞·ª£ng"); return; }

  for(let i=0;i<count;i++){
    await addDoc(collection(db,"keys"),{
      key: randomKey(),
      maxUses: uses || 1,
      used:0,
      createdAt:Date.now(),
      expiresAt:Date.now() + hours*60*60*1000
    });
  }

  alert("ƒê√£ t·∫°o "+count+" key");
  loadKeys();
}

async function loadKeys(){
  keyList.innerHTML="";
  let totalKeys=0;
  let totalGet=0;

  const snapshot = await getDocs(collection(db,"keys"));

  snapshot.forEach(docSnap=>{
    const data = docSnap.data();

    if(Date.now()>data.expiresAt){
      deleteDoc(doc(db,"keys",docSnap.id));
      return;
    }

    totalKeys++;
    totalGet += data.used || 0;

    const div = document.createElement("div");
    div.className="keyItem";
    div.innerHTML = `
      üîë ${data.key}<br>
      ‚è≥ ${new Date(data.expiresAt).toLocaleString()}<br>
      üî• ${data.used || 0}/${data.maxUses}
      <br>
      <button onclick="deleteKey('${docSnap.id}')">X√≥a</button>
    `;
    keyList.appendChild(div);
  });

  totalKeysEl.innerText = totalKeys;
  totalGetEl.innerText = totalGet;
}

window.deleteKey = async function(id){
  await deleteDoc(doc(db,"keys",id));
  loadKeys();
}

window.logout = async function(){
  await signOut(auth);
}

</script>

</body>
</html>
