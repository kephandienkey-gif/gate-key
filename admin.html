<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>ADMIN CONTROL PANEL</title>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { 
  getFirestore, collection, addDoc, getDocs, deleteDoc, doc 
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

import { 
  getAuth, onAuthStateChanged, signOut 
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig = { 
  apiKey : "AIzaSyCBoDV8N9q56YjrNlKoiQk6c6fYDNJL2pw" , 
  authDomain : "kephandienkey-fbee7.firebaseapp.com" , 
  projectId : "kephandienkey-fbee7" , 
  storageBucket : "kephandienkey-fbee7.firebasestorage.app" , 
  messagingSenderId : "1004820527441" , 
  appId : "1:1004820527441:web:a2ffa3aefb82b99a97fb70" 
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const ADMIN_EMAIL = "kephandienkey@gmail.com";

let allKeys = [];
let showAll = false;

onAuthStateChanged(auth, (user) => {
  if (!user || user.email !== ADMIN_EMAIL) {
    alert("Kh√¥ng ph·∫£i admin!");
    window.location.href = "/";
  } else {
    loadKeys();
  }
});

function randomKey() {
  return "KEY-" + Math.random().toString(36).substring(2,10).toUpperCase();
}

// LOAD KEY
async function loadKeys() {
  const snapshot = await getDocs(collection(db, "keys"));
  allKeys = [];
  let totalGet = 0;

  snapshot.forEach(d => {
    const data = d.data();
    totalGet += data.used || 0;

    allKeys.push({
      id: d.id,
      ...data
    });
  });

  document.getElementById("totalKeys").innerText = allKeys.length;
  document.getElementById("totalGet").innerText = totalGet;

  renderKeys();
}

// HI·ªÇN TH·ªä KEY
function renderKeys() {
  const list = document.getElementById("keyList");
  list.innerHTML = "";

  const keysToShow = showAll ? allKeys : allKeys.slice(0,3);

  keysToShow.forEach(k => {
    list.innerHTML += `
      <div class="card">
        üîë ${k.key}<br>
        üî• L∆∞·ª£t get: ${k.used || 0}
        <br><br>
        <button onclick="deleteKey('${k.id}')" class="red">X√ìA</button>
      </div>
    `;
  });

  document.getElementById("toggleBtn").innerText =
    showAll ? "Thu g·ªçn" : "Xem th√™m";
}

window.toggleKeys = function(){
  showAll = !showAll;
  renderKeys();
}

// T·∫†O KEY TH∆Ø·ªúNG
window.createKey = async function(){
  const keyText = document.getElementById("customKey").value.trim();
  const expireDays = parseInt(document.getElementById("expireDays").value);

  if(!keyText || !expireDays) return alert("Nh·∫≠p thi·∫øu!");

  await addDoc(collection(db,"keys"),{
    key: keyText,
    expire: Date.now() + expireDays*24*60*60*1000,
    used:0
  });

  alert("T·∫°o th√†nh c√¥ng!");
  loadKeys();
};

// T·∫†O RANDOM
window.createRandom = async function(){
  await addDoc(collection(db,"keys"),{
    key: randomKey(),
    expire: Date.now() + 1*24*60*60*1000,
    used:0
  });

  alert("ƒê√£ t·∫°o random!");
  loadKeys();
};

// T·∫†O H√ÄNG LO·∫†T
window.createBulk = async function(){
  const amount = parseInt(document.getElementById("bulkAmount").value);
  if(!amount || amount<=0) return alert("Nh·∫≠p s·ªë l∆∞·ª£ng h·ª£p l·ªá");

  for(let i=0;i<amount;i++){
    await addDoc(collection(db,"keys"),{
      key: randomKey(),
      expire: Date.now() + 1*24*60*60*1000,
      used:0
    });
  }

  alert("T·∫°o h√†ng lo·∫°t xong!");
  loadKeys();
};

// X√ìA 1 KEY
window.deleteKey = async function(id){
  await deleteDoc(doc(db,"keys",id));
  loadKeys();
};

// X√ìA T·∫§T C·∫¢
window.deleteAllKeys = async function(){
  if(!confirm("X√≥a to√†n b·ªô key?")) return;

  const snapshot = await getDocs(collection(db,"keys"));
  for(const d of snapshot.docs){
    await deleteDoc(doc(db,"keys",d.id));
  }

  alert("ƒê√£ x√≥a to√†n b·ªô!");
  loadKeys();
};

window.logout = function(){
  signOut(auth);
};

</script>

<style>
body{
  background:#0f0f0f;
  font-family:Arial;
  color:white;
  text-align:center;
}
.panel{
  width:400px;
  margin:20px auto;
  background:#1c1c1c;
  padding:20px;
  border-radius:20px;
}
input{
  width:100%;
  padding:10px;
  margin:5px 0;
  border-radius:10px;
  border:none;
}
button{
  width:100%;
  padding:12px;
  margin:6px 0;
  border:none;
  border-radius:12px;
  font-weight:bold;
  cursor:pointer;
}
.green{background:#00c853;color:white;}
.blue{background:#2979ff;color:white;}
.red{background:#d50000;color:white;}
.orange{background:#ff9100;color:black;}
.card{
  background:#2a2a2a;
  padding:15px;
  margin:10px 0;
  border-radius:15px;
}
</style>
</head>

<body>

<div class="panel">

<h2>üîê ADMIN CONTROL PANEL</h2>

<p>üì¶ T·ªïng key: <span id="totalKeys">0</span></p>
<p>üî• T·ªïng l∆∞·ª£t get: <span id="totalGet">0</span></p>

<h3>T·∫°o Key</h3>

<input id="customKey" placeholder="Nh·∫≠p key mu·ªën t·∫°o">
<input id="expireDays" type="number" placeholder="S·ªë ng√†y s·ª≠ d·ª•ng">

<button onclick="createKey()" class="green">T·∫†O KEY</button>
<button onclick="createRandom()" class="blue">T·∫†O RANDOM</button>

<hr>

<h3>T·∫°o h√†ng lo·∫°t</h3>
<input id="bulkAmount" type="number" placeholder="S·ªë l∆∞·ª£ng key">
<button onclick="createBulk()" class="green">T·∫†O H√ÄNG LO·∫†T</button>

<button onclick="deleteAllKeys()" class="red">
X√ìA T·∫§T C·∫¢ KEY
</button>

<hr>

<h3>Danh s√°ch key</h3>
<div id="keyList"></div>

<button onclick="toggleKeys()" id="toggleBtn" class="blue">
Xem th√™m
</button>

<hr>

<button onclick="logout()" class="orange">
ƒêƒÉng xu·∫•t
</button>

</div>

</body>
</html>
