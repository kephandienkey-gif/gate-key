<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>ADMIN KEY</title>
<style>
body{
  font-family:sans-serif;
  background:#0f0f0f;
  color:white;
  text-align:center;
}
input,button,select{
  padding:10px;
  margin:6px;
  border-radius:10px;
  border:none;
}
button{
  background:#00ff99;
  font-weight:bold;
  cursor:pointer;
}
.danger{
  background:red;
  color:white;
}
.orange{
  background:orange;
  color:black;
}
.keyItem{
  background:#1c1c1c;
  margin:10px auto;
  padding:12px;
  border-radius:10px;
  width:90%;
  max-width:500px;
}
</style>
</head>
<body>

<h2>üîë ADMIN KEY PANEL</h2>

<h3>‚öôÔ∏è T·∫°o key h√†ng lo·∫°t</h3>

<input type="text" id="prefix" placeholder="K√Ω t·ª± ƒë·∫ßu (vd VIP-)">
<input type="number" id="length" placeholder="ƒê·ªô d√†i random (vd 8)">
<input type="number" id="amount" placeholder="S·ªë l∆∞·ª£ng key">
<br>
<input type="number" id="hours" placeholder="H·∫øt h·∫°n sau bao nhi√™u gi·ªù">
<input type="number" id="limit" placeholder="S·ªë l∆∞·ª£t d√πng (vd 1)">
<br>
<button onclick="createBulkKeys()">T·∫†O KEY</button>
<button class="danger" onclick="deleteAllKeys()">X√ìA T·∫§T C·∫¢</button>
<button class="orange" onclick="deleteUsedKeys()">X√ìA KEY ƒê√É D√ôNG</button>

<h3>üìä Th·ªëng k√™</h3>
T·ªïng key: <span id="totalKeys">0</span><br>
T·ªïng l∆∞·ª£t d√πng: <span id="totalGet">0</span>

<h3>üìã Danh s√°ch key</h3>

<select id="filterStatus" onchange="renderKeys()">
  <option value="all">T·∫•t c·∫£</option>
  <option value="unused">Ch∆∞a d√πng</option>
  <option value="used">ƒê√£ d√πng</option>
</select>

<div id="keyList"></div>
<button id="showMoreBtn" onclick="toggleKeys()" style="display:none;">Xem th√™m</button>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = { 
  apiKey: "AIzaSyCBoDV8N9q56YjrNlKoiQk6c6fYDNJL2pw",
  authDomain: "kephandienkey-fbee7.firebaseapp.com",
  projectId: "kephandienkey-fbee7",
  storageBucket: "kephandienkey-fbee7.firebasestorage.app",
  messagingSenderId: "1004820527441",
  appId: "1:1004820527441:web:a2ffa3aefb82b99a97fb70"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let allKeys = [];
let showAll = false;

function randomPart(length){
  const chars="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
  let result="";
  for(let i=0;i<length;i++){
    result+=chars.charAt(Math.floor(Math.random()*chars.length));
  }
  return result;
}

window.createBulkKeys = async function(){

  const prefix=document.getElementById("prefix").value || "";
  const length=parseInt(document.getElementById("length").value) || 8;
  const amount=parseInt(document.getElementById("amount").value);
  const hours=parseInt(document.getElementById("hours").value);
  const limit=parseInt(document.getElementById("limit").value) || 1;

  if(!amount || !hours) return alert("Nh·∫≠p ƒë·ªß s·ªë l∆∞·ª£ng & gi·ªù");

  for(let i=0;i<amount;i++){
    await addDoc(collection(db,"keys"),{
      key: prefix + randomPart(length),
      expire: new Date(Date.now()+hours*60*60*1000),
      limit: limit,
      get: 0
    });
  }

  alert("ƒê√£ t·∫°o "+amount+" key!");
  loadKeys();
}

window.deleteAllKeys = async function(){
  if(!confirm("X√≥a to√†n b·ªô key?")) return;

  const snapshot=await getDocs(collection(db,"keys"));
  for(const docSnap of snapshot.docs){
    await deleteDoc(doc(db,"keys",docSnap.id));
  }
  loadKeys();
}

window.deleteUsedKeys = async function(){
  if(!confirm("X√≥a t·∫•t c·∫£ key ƒë√£ d√πng?")) return;

  const snapshot=await getDocs(collection(db,"keys"));

  for(const docSnap of snapshot.docs){
    const data=docSnap.data();
    if((data.get||0) > 0){
      await deleteDoc(doc(db,"keys",docSnap.id));
    }
  }

  loadKeys();
}

window.toggleKeys = function(){
  showAll = !showAll;
  renderKeys();
}

async function loadKeys(){

  const snapshot=await getDocs(collection(db,"keys"));
  const now=Date.now();

  allKeys=[];
  let totalGet=0;

  for(const docSnap of snapshot.docs){

    const data=docSnap.data();
    const expireTime=data.expire.seconds*1000;

    if(expireTime<=now){
      await deleteDoc(doc(db,"keys",docSnap.id));
      continue;
    }

    allKeys.push({id:docSnap.id,...data});
    totalGet+=data.get||0;
  }

  document.getElementById("totalKeys").innerText=allKeys.length;
  document.getElementById("totalGet").innerText=totalGet;

  renderKeys();
}

function renderKeys(){

  const keyList=document.getElementById("keyList");
  const showMoreBtn=document.getElementById("showMoreBtn");
  const filter=document.getElementById("filterStatus").value;

  keyList.innerHTML="";

  let filteredKeys = allKeys;

  if(filter==="unused"){
    filteredKeys = allKeys.filter(k => (k.get||0) === 0);
  }

  if(filter==="used"){
    filteredKeys = allKeys.filter(k => (k.get||0) > 0);
  }

  let keysToShow = showAll ? filteredKeys : filteredKeys.slice(0,2);

  keysToShow.forEach(data=>{
    const div=document.createElement("div");
    div.className="keyItem";
    div.innerHTML=`
      üîë ${data.key}<br>
      ‚è≥ ${new Date(data.expire.seconds*1000).toLocaleString()}<br>
      üî• ${data.get||0}/${data.limit}<br>
      <button onclick="deleteKey('${data.id}')">X√ìA</button>
    `;
    keyList.appendChild(div);
  });

  if(filteredKeys.length > 2){
    showMoreBtn.style.display="inline-block";
    showMoreBtn.innerText = showAll ? "Thu g·ªçn" : "Xem th√™m";
  } else {
    showMoreBtn.style.display="none";
  }
}

window.deleteKey=async function(id){
  await deleteDoc(doc(db,"keys",id));
  loadKeys();
}

async function autoDeleteExpiredKeys(){
  const snapshot=await getDocs(collection(db,"keys"));
  const now=Date.now();

  for(const docSnap of snapshot.docs){
    const data=docSnap.data();
    if(!data.expire) continue;

    const expireTime=data.expire.seconds*1000;

    if(expireTime<=now){
      await deleteDoc(doc(db,"keys",docSnap.id));
    }
  }

  loadKeys();
}

loadKeys();
setInterval(autoDeleteExpiredKeys,60000);

</script>
</body>
</html>
