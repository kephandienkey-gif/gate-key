<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>ADMIN PANEL</title>
<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { 
  getFirestore, collection, addDoc, getDocs, deleteDoc, 
  doc, updateDoc, getDoc 
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

import { 
  getAuth, onAuthStateChanged 
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig = { 
  apiKey : "AIzaSyCBoDV8N9q56YjrNlKoiQk6c6fYDNJL2pw" , 
  authDomain : "kephandienkey-fbee7.firebaseapp.com" , 
  projectId : "kephandienkey-fbee7" , 
  storageBucket : "kephandienkey-fbee7.firebasestorage.app" , 
  messagingSenderId : "1004820527441" , 
  appId : "1:1004820527441:web:a2ffa3aefb82b99a97fb70" 
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const ADMIN_EMAIL = "kephandienkey@gmail.com";

onAuthStateChanged(auth, (user) => {
  if (!user || user.email !== ADMIN_EMAIL) {
    alert("Không phải admin!");
    window.location.href = "/";
  } else {
    loadKeys();
    loadStats();
  }
});

function randomKey() {
  return "KEY-" + Math.random().toString(36).substring(2,10).toUpperCase();
}

window.createKey = async function() {
  const customKey = document.getElementById("customKey").value.trim();
  const days = parseInt(document.getElementById("days").value);

  const keyValue = customKey || randomKey();

  const expireDate = new Date();
  expireDate.setDate(expireDate.getDate() + days);

  await addDoc(collection(db, "keys"), {
    key: keyValue,
    expire: expireDate.getTime(),
    used: 0
  });

  alert("Tạo key thành công!");
  document.getElementById("customKey").value = "";
  loadKeys();
  loadStats();
};

window.deleteKey = async function(id) {
  await deleteDoc(doc(db, "keys", id));
  loadKeys();
  loadStats();
};

window.deleteAllKeys = async function () {
  if (!confirm("XÓA TOÀN BỘ KEY?")) return;

  const snapshot = await getDocs(collection(db, "keys"));
  const promises = [];

  snapshot.forEach((d) => {
    promises.push(deleteDoc(doc(db, "keys", d.id)));
  });

  await Promise.all(promises);
  alert("Đã xóa tất cả key!");
  loadKeys();
  loadStats();
};

async function loadKeys() {
  const snapshot = await getDocs(collection(db, "keys"));
  const container = document.getElementById("keyList");
  container.innerHTML = "";

  snapshot.forEach((d) => {
    const data = d.data();
    container.innerHTML += `
      <div class="card">
        <b>${data.key}</b><br>
        Hết hạn: ${new Date(data.expire).toLocaleString()}<br>
        Lượt get: ${data.used}<br>
        <button onclick="deleteKey('${d.id}')">Xóa</button>
      </div>
    `;
  });
}

async function loadStats() {
  const snapshot = await getDocs(collection(db, "keys"));
  document.getElementById("totalKeys").innerText = snapshot.size;
}

</script>

<style>
body{
  background:#111;
  color:white;
  font-family:Arial;
  text-align:center;
}
.panel{
  margin:20px auto;
  width:400px;
  padding:20px;
  background:#1e1e1e;
  border-radius:15px;
}
input,button{
  padding:10px;
  margin:5px;
  border-radius:8px;
  border:none;
}
button{
  background:#00bcd4;
  color:white;
  font-weight:bold;
  cursor:pointer;
}
.card{
  background:#2a2a2a;
  padding:15px;
  margin:10px;
  border-radius:10px;
}
.danger{
  background:red;
}
</style>
</head>

<body>

<div class="panel">
  <h2>ADMIN PANEL</h2>

  <p>Tổng số key: <b id="totalKeys">0</b></p>

  <input type="text" id="customKey" placeholder="Nhập key (để trống = random)">
  <br>
  <input type="number" id="days" placeholder="Số ngày hết hạn" value="1">
  <br>
  <button onclick="createKey()">Tạo Key</button>
  <button class="danger" onclick="deleteAllKeys()">Xóa ALL</button>
</div>

<h3>Danh sách key</h3>
<div id="keyList"></div>

</body>
</html>
