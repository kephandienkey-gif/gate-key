<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>ADMIN PANEL</title>

<style>
body{
  background:#111;
  color:white;
  font-family:monospace;
  margin:0;
  padding:20px;
  text-align:center;
}

h2{
  color:cyan;
}

button{
  padding:8px 12px;
  border:none;
  border-radius:6px;
  cursor:pointer;
  font-weight:bold;
  margin:3px;
}

.loadBtn{ background:cyan; }
.deleteBtn{ background:red; color:white; }
.logoutBtn{ background:orange; }

table{
  margin:auto;
  margin-top:20px;
  border-collapse:collapse;
  width:95%;
  max-width:1000px;
}

th,td{
  border:1px solid white;
  padding:8px;
  font-size:13px;
  word-break:break-all;
}

th{
  background:#222;
}
</style>
</head>
<body>

<h2>üî• ADMIN PANEL - GATE KEY SYSTEM üî•</h2>

<button class="loadBtn" onclick="loadKeys()">T·∫¢I DANH S√ÅCH KEY</button>
<button class="logoutBtn" onclick="logout()">THO√ÅT</button>

<br><br>

<div>
  <b>T·ªïng s·ªë key:</b> <span id="total">0</span>
</div>

<table>
  <thead>
    <tr>
      <th>DeviceID</th>
      <th>Key</th>
      <th>H·∫øt h·∫°n</th>
      <th>Tr·∫°ng th√°i</th>
      <th>X√≥a</th>
    </tr>
  </thead>
  <tbody id="keyList"></tbody>
</table>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, getDocs, deleteDoc, doc } 
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCBoDV8N9q56YjrNlKoiQk6c6fYDNJL2pw",
  authDomain: "kephandienkey-fbee7.firebaseapp.com",
  projectId: "kephandienkey-fbee7",
  storageBucket: "kephandienkey-fbee7.firebasestorage.app",
  messagingSenderId: "1004820527441",
  appId: "1:1004820527441:web:a2ffa3aefb82b99a97fb70"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// LOAD TO√ÄN B·ªò KEY
window.loadKeys = async function(){

  const querySnapshot = await getDocs(collection(db,"keys"));
  const list = document.getElementById("keyList");
  list.innerHTML = "";
  let count = 0;

  querySnapshot.forEach((docSnap)=>{

    count++;

    const data = docSnap.data();
    const device = docSnap.id;
    const key = data.key || "Kh√¥ng c√≥";
    const expireTime = data.expire || 0;

    const expireDate = new Date(expireTime).toLocaleString();
    const status = Date.now() > expireTime 
      ? "<span style='color:red'>H·∫æT H·∫†N</span>"
      : "<span style='color:lime'>C√íN H·∫†N</span>";

    list.innerHTML += `
      <tr>
        <td>${device}</td>
        <td>${key}</td>
        <td>${expireDate}</td>
        <td>${status}</td>
        <td>
          <button class="deleteBtn" onclick="deleteKey('${device}')">
            X√ìA
          </button>
        </td>
      </tr>
    `;
  });

  document.getElementById("total").innerText = count;
}

// X√ìA KEY
window.deleteKey = async function(id){
  if(confirm("B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a key n√†y?")){
    await deleteDoc(doc(db,"keys",id));
    alert("ƒê√£ x√≥a th√†nh c√¥ng!");
    loadKeys();
  }
}

// THO√ÅT
window.logout = function(){
  window.location.href = "index.html";
}

</script>

</body>
</html>
