<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>ADMIN KEY PANEL</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body{
  font-family:Arial;
  background:#0f172a;
  color:white;
  margin:0;
}
header{
  background:#1e293b;
  padding:20px;
  font-size:22px;
  text-align:center;
  font-weight:bold;
}
.menu{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  padding:20px;
}
button{
  padding:12px;
  border:none;
  border-radius:10px;
  background:#22c55e;
  font-weight:bold;
  cursor:pointer;
}
input,select{
  padding:8px;
  border-radius:8px;
  border:none;
  margin:5px;
}
.box{
  background:#1e293b;
  margin:20px;
  padding:20px;
  border-radius:15px;
}
.keyitem{
  background:#334155;
  padding:10px;
  margin:8px 0;
  border-radius:10px;
}
.hidden{display:none;}
</style>
</head>
<body>

<header>ğŸ” ADMIN KEY PANEL</header>

<div class="box" id="loginBox">
<h3>ÄÄƒng nháº­p Admin</h3>
<input id="email" placeholder="Email"><br>
<input id="password" type="password" placeholder="Password"><br>
<button onclick="login()">Login</button>
</div>

<div id="adminBox" class="hidden">

<div class="box">
<h3>Táº¡o Key</h3>
<input id="newKey" placeholder="Nháº­p key hoáº·c Ä‘á»ƒ trá»‘ng random">
<input id="expireHours" type="number" placeholder="Sá»‘ giá»">
<input id="limitUse" type="number" placeholder="Giá»›i háº¡n lÆ°á»£t dÃ¹ng">
<button onclick="createKey()">Táº¡o Key</button>
</div>

<div class="box">
<h3>Táº¡o Key HÃ ng Loáº¡t</h3>
<input id="prefix" placeholder="KÃ­ tá»± Ä‘áº§u (VD: VIP-)">
<input id="bulkHours" type="number" placeholder="Sá»‘ giá»">
<input id="bulkAmount" type="number" placeholder="Sá»‘ lÆ°á»£ng key">
<button onclick="createBulk()">Táº¡o HÃ ng Loáº¡t</button>
</div>

<div class="box">
<button onclick="filterType='all';loadKeys()">Táº¥t cáº£</button>
<button onclick="filterType='unused';loadKeys()">ChÆ°a dÃ¹ng</button>
<button onclick="filterType='used';loadKeys()">ÄÃ£ dÃ¹ng</button>
<button onclick="deleteUsed()">XÃ³a táº¥t cáº£ key Ä‘Ã£ dÃ¹ng</button>
<button onclick="deleteAll()">XÃ³a táº¥t cáº£</button>
</div>

<div class="box">
<h3>Danh sÃ¡ch Key</h3>
<div id="keyList"></div>
<button id="toggleBtn" onclick="toggleShow()">Xem thÃªm</button>
</div>

<div class="box">
<h3>Thá»‘ng kÃª</h3>
<p>Tá»•ng key: <span id="totalKeys">0</span></p>
<p>Tá»•ng lÆ°á»£t dÃ¹ng: <span id="totalUses">0</span></p>
</div>

</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyCBoDV8N9q56YjrNlKoiQk6c6fYDNJL2pw",
  authDomain: "kephandienkey-fbee7.firebaseapp.com",
  projectId: "kephandienkey-fbee7",
  storageBucket: "kephandienkey-fbee7.firebasestorage.app",
  messagingSenderId: "1004820527441",
  appId: "1:1004820527441:web:a2ffa3aefb82b99a97fb70"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let showAll=false;
let filterType="all";

window.login=async()=>{
  await signInWithEmailAndPassword(auth,
    email.value,password.value);
}

onAuthStateChanged(auth,user=>{
  if(user){
    loginBox.style.display="none";
    adminBox.classList.remove("hidden");
    loadKeys();
  }
})

function randomKey(prefix="KEY-"){
  return prefix+Math.random().toString(36)
  .substring(2,8).toUpperCase();
}

window.createKey=async()=>{
  let key=newKey.value||randomKey();
  let expire=Date.now()+expireHours.value*3600000;
  await addDoc(collection(db,"keys"),{
    key,
    expire,
    limit:parseInt(limitUse.value)||1,
    used:0
  });
  alert("Táº¡o thÃ nh cÃ´ng");
  loadKeys();
}

window.createBulk=async()=>{
  for(let i=0;i<bulkAmount.value;i++){
    await addDoc(collection(db,"keys"),{
      key:randomKey(prefix.value||"KEY-"),
      expire:Date.now()+bulkHours.value*3600000,
      limit:1,
      used:0
    });
  }
  alert("Táº¡o hÃ ng loáº¡t xong");
  loadKeys();
}

window.loadKeys=async()=>{
  keyList.innerHTML="";
  let totalK=0,totalU=0;
  const snap=await getDocs(collection(db,"keys"));
  let arr=[];
  snap.forEach(d=>{
    let data=d.data();
    if(Date.now()>data.expire){
      deleteDoc(doc(db,"keys",d.id));
      return;
    }
    if(filterType=="unused" && data.used>0)return;
    if(filterType=="used" && data.used==0)return;
    arr.push({...data,id:d.id});
  });

  arr.sort((a,b)=>b.expire-a.expire);

  document.getElementById("totalKeys").innerText=arr.length;

  arr.forEach((k,i)=>{
    totalU+=k.used||0;
    if(!showAll && i>=2)return;
    let div=document.createElement("div");
    div.className="keyitem";
    let remain=Math.floor((k.expire-Date.now())/3600000);
    div.innerHTML=
      `ğŸ”‘ ${k.key}
       <br>â³ CÃ²n: ${remain} giá»
       <br>ğŸ”¥ LÆ°á»£t dÃ¹ng: ${k.used}/${k.limit}
       <br><button onclick="deleteOne('${k.id}')">XÃ³a</button>`;
    keyList.appendChild(div);
  });

  document.getElementById("totalUses").innerText=totalU;
}

window.deleteOne=async(id)=>{
  await deleteDoc(doc(db,"keys",id));
  loadKeys();
}

window.deleteAll=async()=>{
  const snap=await getDocs(collection(db,"keys"));
  snap.forEach(d=>deleteDoc(doc(db,"keys",d.id)));
  loadKeys();
}

window.deleteUsed=async()=>{
  const snap=await getDocs(collection(db,"keys"));
  snap.forEach(d=>{
    if(d.data().used>0)
      deleteDoc(doc(db,"keys",d.id));
  });
  loadKeys();
}

window.toggleShow=()=>{
  showAll=!showAll;
  toggleBtn.innerText=showAll?"Thu gá»n":"Xem thÃªm";
  loadKeys();
}

setInterval(loadKeys,60000);

</script>
</body>
</html>
