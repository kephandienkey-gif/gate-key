<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Check Key</title>
</head>
<body style="background:black;color:lime;font-family:monospace;text-align:center;margin-top:50px;">

<div id="result">Checking key...</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, query, where, getDocs, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = { 
  apiKey: "AIzaSyCBoDV8N9q56YjrNlKoiQk6c6fYDNJL2pw",
  authDomain: "kephandienkey-fbee7.firebaseapp.com",
  projectId: "kephandienkey-fbee7",
  storageBucket: "kephandienkey-fbee7.firebasestorage.app",
  messagingSenderId: "1004820527441",
  appId: "1:1004820527441:web:a2ffa3aefb82b99a97fb70"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const urlParams = new URLSearchParams(window.location.search);
const keyInput = urlParams.get("key");

const resultDiv = document.getElementById("result");

if (!keyInput) {
    resultDiv.innerText = "NO_KEY";
} else {

    try {

        const q = query(
            collection(db, "keys"),
            where("key", "==", keyInput)
        );

        const querySnapshot = await getDocs(q);

        if (querySnapshot.empty) {
            resultDiv.innerText = "INVALID";
        } else {

            querySnapshot.forEach(async (docSnap) => {

                const data = docSnap.data();

                if (data.used >= data.limit) {
                    resultDiv.innerText = "USED";
                }
                else if (Date.now() > data.expire) {
                    resultDiv.innerText = "EXPIRED";
                }
                else {

                    await updateDoc(docSnap.ref, {
                        used: data.used + 1
                    });

                    resultDiv.innerText = "VALID";
                }

            });

        }

    } catch (error) {
        resultDiv.innerText = "ERROR";
    }

}

</script>

</body>
</html>
